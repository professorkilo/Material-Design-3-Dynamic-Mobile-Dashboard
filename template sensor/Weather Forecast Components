# Weather

- sensor:
     - name: "Outdoor Temperature"
       unique_id: outdoor_temperature
       unit_of_measurement: "Â°C"
       state: >
          {{ state_attr('weather.home', 'temperature') }}
       device_class: temperature

     - name: "Outdoor Humidity"
       unique_id: outdoor_humidity
       unit_of_measurement: "%"
       state: >
          {{ state_attr('weather.home', 'humidity') }}
       device_class: humidity

     - name: "Weather Condition Icon"
       unique_id: weather_condition_icon
       state: >
        {% set condition = states('weather.home') | lower %}
        {% if condition in ['sunny', 'clear'] %}
          mdi:weather-sunny
        {% elif condition == 'clear-night' %}
          mdi:weather-night
        {% elif condition in ['partlycloudy', 'partly cloudy'] %}
          mdi:weather-partly-cloudy
        {% elif condition == 'cloudy' %}
          mdi:weather-cloudy
        {% elif condition in ['rainy', 'rain'] %}
          mdi:weather-rainy
        {% elif condition == 'pouring' %}
          mdi:weather-pouring
        {% elif condition == 'windy' %}
          mdi:weather-windy
        {% elif condition in ['fog', 'foggy'] %}
          mdi:weather-fog
        {% elif condition in ['snow', 'snowy'] %}
          mdi:weather-snowy
        {% elif condition == 'snowy-rainy' %}
          mdi:weather-snowy-rainy
        {% elif condition == 'hail' %}
          mdi:weather-hail
        {% elif condition == 'lightning' %}
          mdi:weather-lightning
        {% elif condition == 'lightning-rainy' %}
          mdi:weather-lightning-rainy
        {% elif condition == 'windy-variant' %}
          mdi:weather-windy-variant
        {% elif condition == 'exceptional' %}
          mdi:alert-circle-outline
        {% else %}
          mdi:weather-cloudy-alert
        {% endif %}

     - name: "Rainfall Forecast Today"
       unique_id: rainfall_forecast_today
       state: >
          {% set forecasts = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast','forecasts') %}
          {% if forecasts %}
            {% set total = forecasts | map(attribute='precipitation') | map('float') | sum %}
            {% if total == 0 %}
              none
            {% elif total < 2.5 %}
              light
            {% elif total < 7.6 %}
              moderate
            {% elif total < 35 %}
              heavy
            {% else %}
              very_heavy
            {% endif %}
          {% else %}
            none
          {% endif %}

- sensor:
    - name: "Forecast UV Index"
      unique_id: forecast_uv_index
      unit_of_measurement: "UV"
      state: >
        {% set f = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast', 'forecasts') %}
        {% if f is sequence and f | count > 0 %}
          {{ f[0].uv_index }}
        {% else %}
          unknown
        {% endif %}

    - name: "Forecast Cloud Coverage"
      unique_id: forecast_cloud_coverage
      unit_of_measurement: "%"
      state: >
        {% set f = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast', 'forecasts') %}
        {% if f is sequence and f | count > 0 %}
          {{ f[0].cloud_coverage }}
        {% else %}
          unknown
        {% endif %}

    - name: "Forecast Rainfall"
      unique_id: forecast_rainfall
      unit_of_measurement: "mm"
      state: >
        {% set f = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast', 'forecasts') %}
        {% if f is sequence and f | count > 0 %}
          {{ f[0].precipitation }}
        {% else %}
          unknown
        {% endif %}

    - name: "Forecast Wind Speed"
      unique_id: forecast_wind_speed
      unit_of_measurement: "km/h"
      state: >
        {{ state_attr('weather.home', 'wind_speed') }}

    - name: "Forecast Wind Direction"
      unique_id: forecast_wind_direction
      unit_of_measurement: "Â°"
      state: >
        {{ state_attr('weather.home', 'wind_bearing') }}

    - name: "Forecast Temperature"
      unique_id: forecast_temperature
      unit_of_measurement: "Â°C"
      state: >
        {{ state_attr('weather.home', 'temperature') }}

    - name: "Next Rain Summary"
      state: >
        {%- set forecasts = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast','forecasts') -%}
        {%- if forecasts -%}
        {%- set rain_forecasts = forecasts | selectattr('precipitation','defined') | selectattr('precipitation','gt',0) | list -%}
        {%- if rain_forecasts | count > 0 -%}
        {%- set next_rain = rain_forecasts | first -%}
        {%- set val = next_rain.precipitation | float -%}
        {%- if val < 2.5 -%}ğŸŒ¦ï¸ Light Â· {{ val | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }} Â· {{ as_datetime(next_rain.datetime).strftime('%a, %b %d at %I:%M %p') }}
        {%- elif val < 7.6 -%}ğŸŒ§ï¸ Moderate Â· {{ val | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }} Â· {{ as_datetime(next_rain.datetime).strftime('%a, %b %d at %I:%M %p') }}
        {%- elif val < 35 -%}â›ˆï¸ Heavy Â· {{ val | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }} Â· {{ as_datetime(next_rain.datetime).strftime('%a, %b %d at %I:%M %p') }}
        {%- else -%}â›ˆï¸ Very heavy Â· {{ val | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }} Â· {{ as_datetime(next_rain.datetime).strftime('%a, %b %d at %I:%M %p') }}
        {%- endif -%}
        {%- else -%}ğŸŒ¤ï¸ No rain today{%- endif -%}
        {%- else -%}ğŸŒ¤ï¸ N/A{%- endif -%}

    - name: "24h Rainfall Summary"
      state: >
        {%- set forecasts = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast','forecasts') -%}
        {%- if forecasts -%}
        {%- set values = forecasts | map(attribute='precipitation') | map('float') | list -%}
        {%- set total = values | sum -%}
        {%- set peak = values | max -%}
        {%- set peak_entry = forecasts | selectattr('precipitation','eq', peak) | list | first -%}
        {%- if total == 0 -%}ğŸŒ¤ï¸ Rainfall: None expected in the next 24 hours
        {%- else -%}
        {%- if total < 2.5 -%}{%- set category = 'Light' -%}{%- set emoji = 'ğŸŒ¦ï¸' -%}
        {%- elif total < 7.6 -%}{%- set category = 'Moderate' -%}{%- set emoji = 'ğŸŒ§ï¸' -%}
        {%- elif total < 35 -%}{%- set category = 'Heavy' -%}{%- set emoji = 'â›ˆï¸' -%}
        {%- else -%}{%- set category = 'Very heavy' -%}{%- set emoji = 'ğŸŒŠ' -%}{%- endif -%}
        {{- emoji }} Rainfall: {{ total | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }} ({{ category }}), peaking {{ peak | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }}/hr on {{ as_datetime(peak_entry.datetime).strftime('%a, %b %d at %I:%M %p') }}.
        {%- endif -%}
        {%- else -%}ğŸŒ¤ï¸ Rainfall: N/A{%- endif -%}

    - name: "UV and Cloud Summary"
      state: >
        {%- set forecasts = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast','forecasts') -%}
        {%- if forecasts -%}
        {%- set uv_values = forecasts | map(attribute='uv_index') | map('float') | list -%}
        {%- set peak_uv = uv_values | max -%}
        {%- set peak_entry = forecasts | selectattr('uv_index','eq', peak_uv) | list | first -%}
        {%- set cloud_values = forecasts | map(attribute='cloud_coverage') | map('float') | list -%}
        {%- set avg_cloud = (cloud_values | sum / cloud_values | length) -%}
        {%- if peak_uv < 3 -%}{%- set uv_category = 'Low' -%}{%- set uv_emoji = 'ğŸŸ¢' -%}
        {%- elif peak_uv < 6 -%}{%- set uv_category = 'Moderate' -%}{%- set uv_emoji = 'ğŸŸ¡' -%}
        {%- elif peak_uv < 8 -%}{%- set uv_category = 'High' -%}{%- set uv_emoji = 'ğŸŸ ' -%}
        {%- elif peak_uv < 11 -%}{%- set uv_category = 'Very High' -%}{%- set uv_emoji = 'ğŸ”´' -%}
        {%- else -%}{%- set uv_category = 'Extreme' -%}{%- set uv_emoji = 'ğŸŸ£' -%}{%- endif -%}
        {%- if avg_cloud <= 25 -%}{%- set cloud_category = 'Clear' -%}{%- set cloud_emoji = 'â˜€ï¸' -%}
        {%- elif avg_cloud <= 50 -%}{%- set cloud_category = 'Partly Cloudy' -%}{%- set cloud_emoji = 'ğŸŒ¤ï¸' -%}
        {%- elif avg_cloud <= 75 -%}{%- set cloud_category = 'Mostly Cloudy' -%}{%- set cloud_emoji = 'â›…' -%}
        {%- else -%}{%- set cloud_category = 'Overcast' -%}{%- set cloud_emoji = 'â˜ï¸' -%}{%- endif -%}
        {{- uv_emoji }} Peak UV: {{ peak_uv | round(1) }} ({{ uv_category }}), {{ cloud_emoji }} Avg Cloud: {{ avg_cloud | round(0) }}% ({{ cloud_category }}), peaking at {{ as_datetime(peak_entry.datetime).strftime('%a, %b %d at %I:%M %p') }}.
        {%- else -%}ğŸŒ¤ï¸ UV & Cloud Forecast: N/A{%- endif -%}

    - name: "Wind Summary"
      state: >
        {%- set forecasts = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast','forecasts') -%}
        {%- if forecasts -%}
        {%- set speeds = forecasts | map(attribute='wind_speed') | map('float') | list -%}
        {%- set peak = speeds | max -%}
        {%- set peak_entry = forecasts | selectattr('wind_speed','eq', peak) | list | first -%}
        {%- set avg_bearing = (forecasts | map(attribute='wind_bearing') | list | sum / forecasts | length) -%}
        {%- set direction = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][(avg_bearing / 22.5) | round(0) % 16] -%}
        {%- if peak < 2 -%}{%- set category = 'Calm' -%}{%- set emoji = 'ğŸŒ«ï¸' -%}
        {%- elif peak < 6 -%}{%- set category = 'Light breeze' -%}{%- set emoji = 'ğŸƒ' -%}
        {%- elif peak < 12 -%}{%- set category = 'Gentle breeze' -%}{%- set emoji = 'ğŸŒ¿' -%}
        {%- elif peak < 20 -%}{%- set category = 'Moderate breeze' -%}{%- set emoji = 'ğŸŒ¬ï¸' -%}
        {%- elif peak < 29 -%}{%- set category = 'Fresh breeze' -%}{%- set emoji = 'ğŸ’¨' -%}
        {%- elif peak < 39 -%}{%- set category = 'Strong breeze' -%}{%- set emoji = 'ğŸ’¨' -%}
        {%- elif peak < 50 -%}{%- set category = 'Near gale' -%}{%- set emoji = 'ğŸŒªï¸' -%}
        {%- elif peak < 62 -%}{%- set category = 'Gale' -%}{%- set emoji = 'ğŸŒªï¸' -%}
        {%- elif peak < 75 -%}{%- set category = 'Strong gale' -%}{%- set emoji = 'ğŸŒªï¸' -%}
        {%- else -%}{%- set category = 'Storm' -%}{%- set emoji = 'ğŸŒ€' -%}{%- endif -%}
        {{- emoji }} Winds: {{ peak | round(1) }} {{ state_attr('weather.home', 'wind_speed_unit') }} ({{ category }}), mostly from {{ direction }}, peaking at {{ as_datetime(peak_entry.datetime).strftime('%a, %b %d at %I:%M %p') }}.
        {%- else -%}ğŸŒ¤ï¸ Winds: N/A{%- endif -%}

    - name: "Moon Summary"
      state: >
        {%- set rise = states('sensor.morrinsville_moon_rise') -%}
        {%- set set_ = states('sensor.morrinsville_moon_set') -%}
        {%- set next_full = states('sensor.morrinsville_next_full_moon') -%}
        {%- set phase = states('sensor.morrinsville_moon_phase') or 'Unknown' -%}
        {%- set phase_emoji = {
          'New Moon':'ğŸŒ‘','Waxing Crescent':'ğŸŒ’','First Quarter':'ğŸŒ“','Waxing Gibbous':'ğŸŒ”',
          'Full Moon':'ğŸŒ•','Waning Gibbous':'ğŸŒ–','Last Quarter':'ğŸŒ—','Waning Crescent':'ğŸŒ˜'
        } -%}
        {%- set emoji = phase_emoji.get(phase,'ğŸŒ™') -%}
        {%- if rise not in ['unknown','unavailable','none',''] and set_ not in ['unknown','unavailable','none',''] -%}
        {{- emoji }} {{ phase | replace('_',' ') | title }} â€“ rises {{ as_local(as_datetime(rise)).strftime('%I:%M %p') }}, sets {{ as_local(as_datetime(set_)).strftime('%I:%M %p') }}, next ğŸŒ• {{ as_local(as_datetime(next_full)).strftime('%a, %b %d') }}.
        {%- else -%}ğŸŒ™ Moon data unavailable{%- endif -%}
